<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§× ×™×™×Ÿ ×”×•×¨××” - ××ª×’×¨ ×¤×¡×™×§×” ××¢×©×™×ª</title>
    
    <!-- External Libraries from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #D4B182;
            --dark-slate: #32373c;
            --light-cream: #fdfbf8;
            --gold-dark: #b89968;
            --gold-light: #e8d4b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Assistant', 'Almoni Tzar', sans-serif;
            background: var(--light-cream);
            color: var(--dark-slate);
            overflow-x: hidden;
            font-size: 20px;
        }
        
        .hero-album {
            min-height: 100vh;
            background: linear-gradient(rgba(50, 55, 60, 0.85), rgba(50, 55, 60, 0.85)),
                        url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?w=1920') center/cover fixed;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .glass-form {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gold-divider {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold), var(--gold-light));
            padding: 4rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .gold-divider::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .lift-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid transparent;
        }
        
        .lift-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 20px 40px rgba(212, 177, 130, 0.3);
            border-color: var(--gold);
        }
        
        .icon-outline {
            width: 64px;
            height: 64px;
            stroke: var(--gold);
            stroke-width: 1.1;
            fill: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            color: white;
            padding: 1.25rem 3rem;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 177, 130, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 177, 130, 0.6);
        }
        
        .btn-secondary {
            background: var(--dark-slate);
            color: white;
            padding: 1.25rem 3rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 1.35rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #454a50;
            transform: translateY(-2px);
        }
        
        .answer-option {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 1.75rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            line-height: 1.6;
        }
        
        .answer-option:hover {
            border-color: var(--gold);
            background: var(--light-cream);
            transform: translateX(-4px);
        }
        
        .answer-option.selected {
            background: linear-gradient(135deg, rgba(212, 177, 130, 0.15), rgba(212, 177, 130, 0.25));
            border-color: var(--gold);
            border-width: 3px;
        }
        
        .carousel {
            overflow: hidden;
            position: relative;
            background: var(--dark-slate);
            padding: 3rem 0;
        }
        
        .carousel-track {
            display: flex;
            animation: scroll 20s linear infinite;
        }
        
        .carousel-item {
            min-width: 300px;
            height: 200px;
            margin: 0 1rem;
            border-radius: 12px;
            background-size: cover;
            background-position: center;
        }
        
        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        .progress-bar {
            height: 8px;
            background: var(--gold);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .text-gold {
            color: var(--gold);
        }
        
        .bg-gold {
            background-color: var(--gold);
        }
        
        .border-gold {
            border-color: var(--gold);
        }
        
        .loading-spinner {
            border: 4px solid rgba(212, 177, 130, 0.2);
            border-top: 4px solid var(--gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .quiz-sidebar {
            position: sticky;
            top: 2rem;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--gold);
        }
        
        .product-image-container {
            width: 100%;
            height: 280px;
            background: var(--light-cream);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 2rem;
            border: 3px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .progress-tracker {
            margin-top: 2rem;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem 0;
            position: relative;
        }
        
        .progress-step.completed .progress-pie-number {
            color: #22c55e;
        }
        
        .progress-step.active .progress-pie-number {
            color: var(--gold);
            font-weight: 800;
        }
        
        /* Pie Chart Progress */
        .progress-pie {
            width: 70px;
            height: 70px;
            position: relative;
        }
        
        .progress-pie svg {
            transform: rotate(-90deg);
        }
        
        .progress-pie-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 7;
        }
        
        .progress-pie-fill {
            fill: none;
            stroke-width: 7;
            stroke-linecap: round;
            transition: stroke-dasharray 0.6s ease, stroke 0.3s ease;
        }
        
        .progress-pie-fill.empty {
            stroke: #e5e7eb;
            stroke-dasharray: 0 100;
        }
        
        .progress-pie-fill.partial {
            stroke: #f59e0b;
            stroke-dasharray: 33 100;
        }
        
        .progress-pie-fill.complete {
            stroke: #22c55e;
            stroke-dasharray: 100 100;
        }
        
        .progress-pie-fill.perfect {
            stroke: #22c55e;
            stroke-dasharray: 100 100;
            filter: drop-shadow(0 0 6px rgba(34, 197, 94, 0.5));
        }
        
        .progress-pie-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 1.4rem;
            color: var(--dark-slate);
        }
        
        /* Timer */
        .question-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .timer-circle {
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .timer-circle svg {
            transform: rotate(-90deg);
        }
        
        .timer-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 6;
        }
        
        .timer-progress {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dasharray 1s linear, stroke 0.3s ease;
        }
        
        .timer-progress.normal {
            stroke: var(--gold);
        }
        
        .timer-progress.warning {
            stroke: #f59e0b;
        }
        
        .timer-progress.danger {
            stroke: #ef4444;
            animation: pulse-timer 1s infinite;
        }
        
        @keyframes pulse-timer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .timer-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark-slate);
        }
        
        .timer-label {
            margin-right: 1rem;
            font-size: 1.1rem;
            color: var(--dark-slate);
            font-weight: 600;
        }
        
        /* Feedback Messages */
        .feedback-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: fadeInScale 0.4s ease;
            text-align: center;
        }
        
        .feedback-message.correct {
            border: 3px solid #22c55e;
        }
        
        .feedback-message.wrong {
            border: 3px solid #f59e0b;
        }
        
        .feedback-message.timeout {
            border: 3px solid var(--gold);
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* Confetti Effect */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--gold);
            animation: confetti-fall 1s ease-out forwards;
            pointer-events: none;
            z-index: 999;
        }
        
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Shake Animation for Wrong Answer */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .shake {
            animation: shake 0.4s ease;
        }
        
        /* Slide Transition */
        .slide-out-left {
            animation: slideOutLeft 0.4s ease forwards;
        }
        
        .slide-in-right {
            animation: slideInRight 0.4s ease forwards;
        }
        
        @keyframes slideOutLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Screen 1: Hero Album -->
    <div id="screen-lobby" class="hero-album">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <!-- Right: Marketing Copy -->
                <div class="text-white fade-in">
                    <h1 class="text-7xl md:text-8xl font-bold mb-6" style="line-height: 1.2;">
                        ×•×•××¡ ×•×•×¢×¡×˜×• ××›×¨×™×¢?
                    </h1>
                    <h2 class="text-5xl md:text-6xl mb-8 text-gold">
                        ××ª×’×¨ ×¤×¡×™×§×” ××¢×©×™×ª
                    </h2>
                    <p class="text-2xl md:text-3xl mb-6 leading-relaxed opacity-90">
                        ×©××œ×•×ª ××¢×©×™×•×ª ×××™×ª×™×•×ª ×©××’×™×¢×•×ª ××‘×ª×™ ×”×•×¨××” ×‘×¤×•×¢×œ.<br>
                        ×‘×•× × ×¨××” ××™×š ××ª×” ×¤×•×¡×§ ×‘×©×˜×— - ×‘×–××Ÿ ×××ª, ×ª×—×ª ×œ×—×¥.
                    </p>
                    <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-lg p-6 mb-8 border border-white border-opacity-20">
                        <p class="text-2xl mb-4">
                            ×‘×—×¨ ××ª ×”×ª×—×•× ×”×”×œ×›×ª×™ ×©×‘×• ×ª×¨×¦×” ×œ×”×ª××•×“×“ ×¢× ×©××œ×•×ª ××”×©×˜×—.
                        </p>
                        <p class="text-gold font-bold text-2xl">
                            ×”×›×¨×¢ × ×›×•×Ÿ, ×•×–×›×” ×‘×”×˜×‘×•×ª ×™×§×¨×•×ª ×¢×¨×š ×œ×œ×™××•×“×™ ×”×•×¨××” + ×”×’×¨×œ×” ×¢×œ ×©×‘×ª '×’×•×œ×“×™×¡' ××¤×•××¨×ª.
                        </p>
                    </div>
                </div>
                
                <!-- Left: Glass Form -->
                <div class="glass-form fade-in">
                    <h3 class="text-4xl font-bold text-white mb-6 text-center">×‘×—×¨ ×ª×—×•× ×œ××ª×’×¨ ×¤×¡×™×§×”</h3>
                    <div class="space-y-4">
                        <button onclick="startQuiz('shabbat')" class="btn-primary w-full text-center">
                            ğŸ•¯ï¸ ×©××œ×•×ª ××¢×©×™×•×ª ×‘×”×œ×›×•×ª ×©×‘×ª
                        </button>
                        <button onclick="startQuiz('issur_heter')" class="btn-primary w-full text-center">
                            ğŸ¥© ×©××œ×•×ª ××¢×©×™×•×ª ×‘××™×¡×•×¨ ×•×”×™×ª×¨
                        </button>
                    </div>
                    <p class="text-white text-xl mt-6 text-center opacity-80">
                        × ×™×ª×Ÿ ×œ×”×ª××•×“×“ ×‘×©× ×™ ×”×ª×—×•××™× ×•×œ×”×›×¤×™×œ ××ª ×¡×™×›×•×™×™ ×”×–×›×™×™×”
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Slogan Divider -->
    <div class="gold-divider">
        <h2 class="text-6xl md:text-7xl font-bold text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
            ××”×©×˜×—, ×œ×¤×¡×™×§×”, ×œ××¢×©×”!
        </h2>
    </div>

    <!-- Screen 2: Question Interface -->
    <div id="screen-question" class="hidden" style="background: var(--light-cream); min-height: 100vh; padding: 3rem 0;">
        <div class="container mx-auto px-4" style="max-width: 1400px;">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content - Left Side -->
                <div class="lg:col-span-2">
                    <div class="lift-card fade-in">
                        <!-- Status Bar -->
                        <div class="mb-6 pb-4" style="border-bottom: 2px solid var(--gold);">
                            <div class="flex justify-between items-center" style="color: var(--dark-slate);">
                                <span id="question-counter" class="font-bold text-3xl">×©××œ×” 1 ××ª×•×š 5</span>
                                <span id="quiz-topic" class="font-medium text-gold text-2xl">× ×•×©×: ×”×œ×›×•×ª ×©×‘×ª</span>
                            </div>
                            <div class="mt-4 bg-gray-200 rounded-full" style="height: 12px;">
                                <div id="progress-bar" class="progress-bar" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <!-- Timer -->
                        <div class="question-timer">
                            <span class="timer-label">×–××Ÿ × ×•×ª×¨:</span>
                            <div class="timer-circle">
                                <svg width="80" height="80">
                                    <circle class="timer-bg" cx="40" cy="40" r="34"></circle>
                                    <circle id="timer-progress" class="timer-progress normal" cx="40" cy="40" r="34" 
                                            style="stroke-dasharray: 213.6 213.6;"></circle>
                                </svg>
                                <div id="timer-number" class="timer-number">30</div>
                            </div>
                        </div>
                        
                        <!-- Question Area -->
                        <div class="mb-8">
                            <div id="question-text" class="text-3xl md:text-4xl font-semibold leading-relaxed mb-8" style="color: var(--dark-slate);">
                                <!-- Question will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Answer Options -->
                        <div id="answers-container" class="space-y-5 mb-6">
                            <!-- Answers will be loaded here -->
                        </div>
                        
                        <!-- Special Button -->
                        <div class="mt-8 pt-6" style="border-top: 1px solid #e5e7eb;">
                            <button onclick="showNeedReview()" class="btn-secondary w-full">
                                ğŸ“š ×¦×¨×™×š ×¢×™×•×Ÿ (×’× ××•×¨×” ×”×•×¨××” ×¤×•×ª×— ×¡×¤×¨ ×œ×¤×¢××™×)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar - Right Side -->
                <div class="lg:col-span-1">
                    <div class="quiz-sidebar fade-in">
                        <!-- Product Image -->
                        <div class="product-image-container">
                            <img id="product-image" src="https://images.unsplash.com/photo-1584308972272-9e4e7685e80f?w=400" alt="××•×¦×¨" style="display: block;">
                            <div id="product-placeholder" style="display: none; color: var(--gold); font-size: 4rem;">ğŸ“¦</div>
                        </div>
                        
                        <!-- Progress Tracker -->
                        <div class="progress-tracker">
                            <h3 class="text-2xl font-bold mb-4 text-gold text-center">×”×ª×§×“××•×ª ×‘×¤×¡×™×§×”</h3>
                            <div id="progress-steps" style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen 3: Need Review Popup -->
    <div id="screen-need-review" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden" style="z-index: 1000;">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full fade-in">
            <h2 class="text-4xl font-bold mb-4 text-center text-gold">
                "××ª×•× ×™× ×”×™×• ×‘×“×™×Ÿ"
            </h2>
            
            <p class="mb-6 leading-relaxed text-xl" style="color: var(--dark-slate);">
                ×× ×—× ×• ××¢×¨×™×›×™× ××ª ×”×–×”×™×¨×•×ª ×©×œ×š. ×¤×•×¡×§ ×××™×ª×™ ×™×•×“×¢ ××ª×™ ×¦×¨×™×š ×œ×¢×™×™×Ÿ ×‘××§×•×¨×•×ª ×œ×¤× ×™ ×”×›×¨×¢×”.
            </p>
            
            <p class="mb-6 leading-relaxed text-xl" style="color: var(--dark-slate);">
                ×›×“×™ ×©×ª×•×›×œ ×œ×¢×™×™×Ÿ ×‘× ×—×ª ×•×œ×—×–×•×¨ ×œ×¤×¡×•×§ ×›×©××ª×” ×‘×˜×•×—, ×©××¨× ×• ×œ×š ××ª ×”××§×•×.
                ×”×›× ×¡ ×¤×¨×˜×™× ×œ×§×‘×œ×ª ×§×™×©×•×¨ ××™×©×™ ×œ×”××©×š ××ª×’×¨ ×”×¤×¡×™×§×” ×‘×“×™×•×§ ××”× ×§×•×“×” ×”×–×•.
            </p>
            
            <form id="pause-form" class="space-y-4">
                <div>
                    <label class="block font-medium mb-2 text-lg" style="color: var(--dark-slate);">×©×:</label>
                    <input type="text" id="pause-name" required
                           class="w-full px-4 py-3 border-2 rounded-lg text-xl" style="border-color: var(--gold);">
                </div>
                
                <div>
                    <label class="block font-medium mb-2 text-lg" style="color: var(--dark-slate);">×•×•××˜×¡××¤/××™×™×œ:</label>
                    <input type="text" id="pause-contact" required
                           class="w-full px-4 py-3 border-2 rounded-lg text-xl" style="border-color: var(--gold);">
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 btn-primary">
                        ×©×œ×—×• ×œ×™ ×œ×™× ×§ ×œ×”××©×š ×”××‘×—×Ÿ
                    </button>
                    <button type="button" onclick="closeNeedReview()" class="px-6 py-3 border-2 rounded-lg text-lg" style="border-color: var(--dark-slate);">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Screen 4: Lead Collection -->
    <div id="screen-lead-collection" class="hidden" style="background: var(--light-cream); min-height: 100vh; padding: 3rem 0;">
        <div class="container mx-auto px-4 max-w-2xl">
            <div class="lift-card fade-in">
                <h2 class="text-4xl md:text-5xl font-bold mb-4 text-center text-gold">
                    ×”×¤×¡×™×§×•×ª ×©×œ×š × ×§×œ×˜×•.
                </h2>
                
                <p class="mb-6 leading-relaxed text-xl" style="color: var(--dark-slate);">
                    ×”×”×›×¨×¢×•×ª ×©×œ×š × ×§×œ×˜×• ×‘××¢×¨×›×ª ×•×¢×•×‘×“×• ××•×œ ×¤×¡×™×§×•×ª ×©×œ ×××•×ª ××•×¨×™ ×”×•×¨××” ××—×¨×™×.
                </p>
                
                <div class="rounded-lg p-6 mb-8" style="background: linear-gradient(135deg, rgba(212, 177, 130, 0.1), rgba(212, 177, 130, 0.2));">
                    <p class="font-bold mb-3 text-gold text-xl">
                        ×œ×¤× ×™ ×©× ×—×©×•×£ ××ª ×”×ª×•×¦××•×ª:
                    </p>
                    <p class="mb-2 text-lg" style="color: var(--dark-slate);">
                        ××œ× ××ª ×”×¤×¨×˜×™× ×›×“×™ ×©× ×•×›×œ:
                    </p>
                    <ul class="list-disc list-inside space-y-1 mr-4 text-lg" style="color: var(--dark-slate);">
                        <li>×œ×”×¦×™×’ ×œ×š × ×™×ª×•×— ××¤×•×¨×˜ ×©×œ ×”×¤×¡×™×§×•×ª ×©×œ×š.</li>
                        <li>×œ×©×œ×•×— ×œ×š ××ª ×“×£ ×”××§×•×¨×•×ª ×•×”×¤×¡×™×§×” ×”××œ××” ×œ××¢×©×”.</li>
                        <li>×œ×™×¦×•×¨ ×§×©×¨ ×œ××™××•×© ×”×”×˜×‘×•×ª ×•×”×–×›×™×™×” ×‘×”×’×¨×œ×”.</li>
                    </ul>
                </div>
                
                <form id="lead-form" class="space-y-4">
                    <div>
                        <label class="block font-medium mb-2 text-lg" style="color: var(--dark-slate);">×©× ××œ×:</label>
                        <input type="text" id="lead-name" required
                               class="w-full px-4 py-3 border-2 rounded-lg text-xl" style="border-color: var(--gold);">
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2 text-lg" style="color: var(--dark-slate);">×˜×œ×¤×•×Ÿ × ×™×™×“:</label>
                        <input type="tel" id="lead-phone" required
                               class="w-full px-4 py-3 border-2 rounded-lg text-xl" style="border-color: var(--gold);"
                               placeholder="050-1234567">
                    </div>
                    
                    <div>
                        <label class="block font-medium mb-2 text-lg" style="color: var(--dark-slate);">××™×™×œ:</label>
                        <input type="email" id="lead-email" required
                               class="w-full px-4 py-3 border-2 rounded-lg text-xl" style="border-color: var(--gold);"
                               placeholder="example@email.com">
                    </div>
                    
                    <button type="submit" class="w-full btn-primary">
                        ×—×©×•×£ ××ª ×”×¤×¡×™×§×•×ª ×©×œ×™ â—€
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Screen 5: Results & Rewards -->
    <div id="screen-results" class="hidden" style="background: var(--light-cream); min-height: 100vh; padding: 3rem 0;">
        <div class="container mx-auto px-4 max-w-3xl">
            <div class="lift-card fade-in">
                <!-- Results Header -->
                <div id="results-header" class="text-center mb-8">
                    <!-- Will be populated based on score -->
                </div>
                
                <!-- Score Display -->
                <div class="rounded-xl p-8 text-white text-center mb-8" style="background: linear-gradient(135deg, var(--gold-dark), var(--gold), var(--gold-light));">
                    <div class="text-6xl font-bold mb-2" id="final-score">85%</div>
                    <div class="text-xl font-semibold">×”×¦×™×•×Ÿ ×©×œ×š</div>
                </div>
                
                <!-- Social Proof Stats -->
                <div id="social-stats" class="rounded-lg p-6 mb-8" style="background: linear-gradient(135deg, rgba(212, 177, 130, 0.1), rgba(212, 177, 130, 0.15));">
                    <!-- Will be populated with stats -->
                </div>
                
                <!-- Benefit Selection -->
                <div class="mb-8">
                    <h3 class="text-3xl font-bold mb-4 text-center text-gold">
                        "×©×›×¨ ×œ×™××•×“ ×”×œ×™×›×”" â€“ ×‘×—×¨ ××ª ×”×”×˜×‘×” ×©×œ×š:
                    </h3>
                    
                    <p class="mb-6 leading-relaxed text-xl" style="color: var(--dark-slate);">
                        ×‘× ×•×¡×£ ×œ×”×’×¨×œ×”, ×–×›×™×ª ×‘×”×˜×‘×” ××•×‘×˜×—×ª ×œ×”×¦×˜×¨×¤×•×ª ×œ××—×“ ×××¡×œ×•×œ×™ ×”×›×©×¨×ª ×”××•×¨×™× ×©×œ× ×•.
                        ×‘××™×–×” × ×•×©× ××ª×” ××¨×’×™×© ×©××ª×” ×¨×•×¦×” ×œ×”×ª×—×–×§ ×•×œ×”×¤×•×š ×œ××•×¨×” ×”×•×¨××”?
                    </p>
                    
                    <form id="benefit-form" class="space-y-3">
                        <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all" style="border-color: #e5e7eb;">
                            <input type="radio" name="benefit" value="shabbat_course_discount" required class="ml-3">
                            <span class="text-xl" style="color: var(--dark-slate);">×”×œ×›×•×ª ×©×‘×ª - ×”×˜×‘×” ×¢"×¡ 400 â‚ª ×œ×§×•×¨×¡ ×”×§×¨×•×‘</span>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all" style="border-color: #e5e7eb;">
                            <input type="radio" name="benefit" value="issur_heter_course_discount" required class="ml-3">
                            <span class="text-xl" style="color: var(--dark-slate);">××™×¡×•×¨ ×•×”×™×ª×¨ - ×”×˜×‘×” ×¢"×¡ 400 â‚ª ×œ×§×•×¨×¡ ×”×§×¨×•×‘</span>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all" style="border-color: #e5e7eb;">
                            <input type="radio" name="benefit" value="niddah_course_discount" required class="ml-3">
                            <span class="text-xl" style="color: var(--dark-slate);">×”×œ×›×•×ª × ×™×“×”/×˜×”×¨×” - ×”×˜×‘×” ×¢"×¡ 500 â‚ª</span>
                        </label>
                        
                        <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all" style="border-color: #e5e7eb;">
                            <input type="radio" name="benefit" value="mamonot_special" required class="ml-3">
                            <span class="text-xl" style="color: var(--dark-slate);">×××•× ×•×ª (×—×•×©×Ÿ ××©×¤×˜) - ×”×˜×‘×” ××™×•×—×“×ª</span>
                        </label>
                        
                        <button type="submit" class="w-full btn-primary mt-6">
                            ××©×¨ ×‘×—×™×¨×” ×•×©××•×¨
                        </button>
                    </form>
                </div>
                
                <!-- Final Actions -->
                <div id="final-actions" class="hidden">
                    <div class="rounded-lg p-6 mb-6 text-center" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.2)); border: 2px solid #22c55e;">
                        <p class="font-medium text-xl" style="color: #15803d;">
                            âœ… ×”×¤×¨×˜×™× ×©×œ×š ×¢×•×“×›× ×•. × ×¦×™×’ ×™×—×–×•×¨ ××œ×™×š ×œ××™××•×© ×”×”×˜×‘×”.
                        </p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="downloadPDF()" class="w-full btn-primary">
                            ğŸ“¥ ×”×•×¨×“ ××ª ×§×•×‘×¥ ×”×ª×©×•×‘×•×ª ×•×”××§×•×¨×•×ª (PDF)
                        </button>
                        
                        <button onclick="restartQuiz()" class="w-full btn-secondary">
                            ğŸ”„ ×¨×•×¦×” ×œ×”×›×¤×™×œ ×¡×™×›×•×™×™×? ×”×™×‘×—×Ÿ ×¢×›×©×™×• ×‘× ×•×©× ×”×©× ×™!
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Carousel Section -->
    <div class="carousel">
        <div class="carousel-track">
            <div class="carousel-item" style="background-image: url('https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=400');"></div>
            <div class="carousel-item" style="background-image: url('https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?w=400');"></div>
            <div class="carousel-item" style="background-image: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?w=400');"></div>
            <div class="carousel-item" style="background-image: url('https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400');"></div>
            <div class="carousel-item" style="background-image: url('https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=400');"></div>
            <div class="carousel-item" style="background-image: url('https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?w=400');"></div>
        </div>
    </div>

    <!-- PDF Export Container (hidden) -->
    <div id="pdf-content" class="hidden" style="padding: 40px; background: white;">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: var(--gold); font-size: 36px; margin-bottom: 10px;">×§× ×™×™×Ÿ ×”×•×¨××”</h1>
            <h2 style="color: var(--dark-slate); font-size: 24px;">×ª×•×¦××•×ª ×”××‘×—×Ÿ ×•××§×•×¨×•×ª</h2>
        </div>
        <div id="pdf-user-info" style="margin-bottom: 30px;"></div>
        <div id="pdf-score" style="margin-bottom: 30px;"></div>
        <div id="pdf-questions" style="margin-top: 30px;"></div>
    </div>

    <script>
const CSV_URLS = {
    shabbat: 'https://docs.google.com/spreadsheets/d/e/YOUR_SHABBAT_SHEET_ID/pub?output=csv',
    issur_heter: 'https://docs.google.com/spreadsheets/d/e/YOUR_ISSUR_HETER_SHEET_ID/pub?output=csv'
};

let firebaseConfig = {
    apiKey: "AIzaSyC1g2vKVbO9hQReaNJ2R3CaLX_0Lc3HwCQ",
    authDomain: "kinyan-26210.firebaseapp.com",
    projectId: "kinyan-26210",
    storageBucket: "kinyan-26210.firebasestorage.app",
    messagingSenderId: "443697566818",
    appId: "1:443697566818:web:ed548251d67df16e6bed3b",
    measurementId: "G-HM09TZR0HW"
};

let db = null;
let firebaseEnabled = false;

try {
    if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        
        db.settings({
            experimentalForceLongPolling: true,
            experimentalAutoDetectLongPolling: true
        });
        
        firebaseEnabled = true;
        console.log('Firebase initialized successfully with Long Polling (NetFree compatible)');
    } else {
        console.log('Firebase not configured - running in local mode');
    }
} catch (error) {
    console.log('Firebase initialization failed - running in local mode:', error);
    firebaseEnabled = false;
}

let currentQuiz = null;
let currentQuestionIndex = 0;
let userAnswers = {};
let currentAttemptId = null;
let quizData = null;
let userData = {
    phone: null,
    name: null,
    email: null
};
let csvCache = {};
let questionTimer = null;
let timeRemaining = 30;
let questionAnswerStatus = {};

function showScreen(screenId) {
    const screens = ['screen-lobby', 'screen-question', 'screen-lead-collection', 'screen-results'];
    screens.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.add('hidden');
        }
    });
    const targetScreen = document.getElementById(screenId);
    if (targetScreen) {
        targetScreen.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

async function startQuiz(quizType) {
    currentQuiz = quizType;
    currentQuestionIndex = 0;
    userAnswers = {};
    questionAnswerStatus = {};
    
    const urlParams = new URLSearchParams(window.location.search);
    const resumeMode = urlParams.get('resume');
    const resumePhone = urlParams.get('phone');
    const resumeQuiz = urlParams.get('quiz');
    
    if (resumeMode && resumePhone && resumeQuiz === quizType) {
        await resumeQuizFromPause(resumePhone, quizType);
    } else {
        await loadQuizData(quizType);
        await createNewAttempt();
        saveToLocalStorage();
        showQuestion();
    }
}

async function loadQuizData(quizType) {
    const topicName = quizType === 'shabbat' ? '×”×œ×›×•×ª ×©×‘×ª' : '××™×¡×•×¨ ×•×”×™×ª×¨';
    document.getElementById('quiz-topic').textContent = `× ×•×©×: ${topicName}`;
    
    if (csvCache[quizType]) {
        quizData = csvCache[quizType];
        return;
    }
    
    try {
        const csvUrl = CSV_URLS[quizType];
        if (csvUrl && !csvUrl.includes('YOUR_')) {
            const response = await fetch(csvUrl);
            const csvText = await response.text();
            quizData = parseCSV(csvText, topicName);
            csvCache[quizType] = quizData;
            console.log('Questions loaded from CSV successfully');
        } else {
            quizData = getDefaultQuizData(quizType);
            console.log('Using default questions (CSV URL not configured)');
        }
    } catch (error) {
        console.error('Error loading CSV, using default questions:', error);
        quizData = getDefaultQuizData(quizType);
    }
}

function parseCSV(csvText, title) {
    const lines = csvText.split('\n').filter(line => line.trim());
    const questions = [];
    
    for (let i = 1; i < lines.length; i++) {
        const parts = parseCSVLine(lines[i]);
        if (parts.length >= 6) {
            questions.push({
                question: parts[0],
                options: [parts[1], parts[2], parts[3]],
                correctIndex: parseInt(parts[4]) - 1,
                explanation: parts[5]
            });
        }
    }
    
    return {
        title: title,
        questions: questions.length > 0 ? questions : getDefaultQuizData(title === '×”×œ×›×•×ª ×©×‘×ª' ? 'shabbat' : 'issur_heter').questions
    };
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current.trim());
    return result;
}

function getDefaultQuizData(quizType) {
    const shabbatQuestions = [
        {
            question: "××“× ×©×”×’×™×¢ ×œ×‘×™×ª ×”×›× ×¡×ª ×‘×©×‘×ª ×•×”×‘×—×™×Ÿ ×©×”×•× ×©×›×— ××ª ×”×˜×œ×™×ª ×‘×‘×™×ª. ×”×‘×™×ª × ××¦× ×‘××¨×—×§ ×©×œ 5 ×“×§×•×ª ×”×œ×™×›×” ×‘×ª×•×š ×”×¢×™×¨×•×‘. ××” ×¢×œ×™×• ×œ×¢×©×•×ª?",
            options: [
                "××¡×•×¨ ×œ×—×–×•×¨, ×›×™ ××™×Ÿ ×—×•×–×¨×™× ×¢×œ ×˜×œ×™×ª ×‘×©×‘×ª",
                "××•×ª×¨ ×œ×—×–×•×¨, ××‘×œ ×¨×§ ×× ×¢×“×™×™×Ÿ ×œ× ×”×ª×—×™×œ×” ×”×ª×¤×™×œ×”",
                "××•×ª×¨ ×œ×—×–×•×¨ ×‘×›×œ ××§×¨×”, ×›×™ ×–×” ×‘×ª×•×š ×”×¢×™×¨×•×‘ ×•×œ×¦×•×¨×š ××¦×•×•×”"
            ],
            correctIndex: 1,
            explanation: "×œ×¤×™ ×”×©×•×œ×—×Ÿ ×¢×•×¨×š (××•\"×— ×¡×™' ×—), ××•×ª×¨ ×œ×—×–×•×¨ ×¢×œ ×˜×œ×™×ª ×¨×§ ×× ×¢×“×™×™×Ÿ ×œ× ×”×ª×—×™×œ ×œ×”×ª×¤×œ×œ. ×× ×›×‘×¨ ×”×ª×—×™×œ - ××¡×•×¨ ×œ×—×–×•×¨."
        },
        {
            question: "××™×©×” ×”×“×œ×™×§×” × ×¨×•×ª ×©×‘×ª ×•×©×›×—×” ×œ×›×‘×•×ª ××ª ×”××•×¨ ×‘××˜×‘×—. ×”×× ××•×ª×¨ ×œ×” ×œ×‘×§×© ××‘×¢×œ×” (×©×¢×“×™×™×Ÿ ×œ× ×§×™×‘×œ ×©×‘×ª) ×œ×›×‘×•×ª?",
            options: [
                "××¡×•×¨, ×›×™ ×”×™× ×›×‘×¨ ×§×™×‘×œ×” ×©×‘×ª ×•××¡×•×¨ ×œ×” ×œ×’×¨×•× ×œ××œ××›×”",
                "××•×ª×¨, ×›×™ ×”×‘×¢×œ ×¢×“×™×™×Ÿ ×œ× ×§×™×‘×œ ×©×‘×ª",
                "××•×ª×¨ ×¨×§ ×× ×™×© ×—×©×© ×¡×›× ×” ××• ×”×¤×¡×“ ×××•×Ÿ ××©××¢×•×ª×™"
            ],
            correctIndex: 0,
            explanation: "××£ ×©×”×‘×¢×œ ×¢×“×™×™×Ÿ ×œ× ×§×™×‘×œ ×©×‘×ª, ×”××™×©×” ×©×›×‘×¨ ×§×™×‘×œ×” ×©×‘×ª ××¡×•×¨×” ×œ×‘×§×© ××× ×• ×œ×¢×©×•×ª ××œ××›×” ×¢×‘×•×¨×” (××©× ×” ×‘×¨×•×¨×”)."
        },
        {
            question: "×™×œ×“ ×‘×Ÿ 11 ×‘×™×§×© ×œ×¤×ª×•×— ××ª ×”××•×¨ ×‘×—×“×¨ ×‘×©×‘×ª. ×”×× ××•×ª×¨ ×œ××‘ ×œ×”× ×™×— ×œ×•?",
            options: [
                "××•×ª×¨, ×›×™ ×§×˜×Ÿ ×©×¢×•×©×” ××œ××›×” ××“×¢×ª×• - ××™×Ÿ ××—×•×™×‘×™× ×œ×× ×•×¢ ××× ×•",
                "××¡×•×¨, ×™×© ×—×™×•×‘ ×—×™× ×•×š ×•×œ×›×Ÿ ×—×™×™×‘×™× ×œ×× ×•×¢ ××× ×•",
                "×ª×œ×•×™ ×× ×”×•× ×›×‘×¨ ×”×’×™×¢ ×œ×’×™×œ ×—×™× ×•×š (×‘×Ÿ 9-10) ××• ×œ×"
            ],
            correctIndex: 1,
            explanation: "×™×© ×—×™×•×‘ ××“×¨×‘× ×Ÿ ×œ×—× ×š ×™×œ×“×™× ×‘×©××™×¨×ª ×©×‘×ª ××’×™×œ ×©××‘×™×Ÿ (×‘×¢×¨×š 6-7). ×œ×›×Ÿ ×—×™×™×‘×™× ×œ×× ×•×¢ ××™×œ×“ ×œ×¢×©×•×ª ××œ××›×” ×‘×©×‘×ª."
        },
        {
            question: "××“× ×©×©×›×— ×•×”×“×œ×™×§ ×¡×™×’×¨×™×” ×‘×©×‘×ª (×‘×©×•×’×’). ××” ×¢×œ×™×• ×œ×¢×©×•×ª?",
            options: [
                "×œ×–×¨×•×§ ××™×“ ××ª ×”×¡×™×’×¨×™×” ×•×œ×›×‘×•×ª ××•×ª×”",
                "×œ×”× ×™×— ××ª ×”×¡×™×’×¨×™×” ×¢×œ ××©×˜×— ×‘×˜×•×— ×•×œ× ×œ×›×‘×•×ª",
                "×œ×”××©×™×š ×œ×¢×©×Ÿ ×›×™ ×××™×œ× ×›×‘×¨ ×¢×‘×¨ ×¢×œ ×”××™×¡×•×¨"
            ],
            correctIndex: 1,
            explanation: "××¡×•×¨ ×œ×›×‘×•×ª ××ª ×”×¡×™×’×¨×™×” ×›×™ ×–×• ××œ××›×” × ×•×¡×¤×ª. ×™×© ×œ×”× ×™×—×” ×‘××§×•× ×‘×˜×•×— ×•×œ× ×œ×›×‘×•×ª (×©×•\"×¢ ×•××©× ×” ×‘×¨×•×¨×”)."
        },
        {
            question: "×ª×™× ×•×§ ×©×‘×›×” ×‘×©×‘×ª ×•×”×× ×¦×¨×™×›×” ×œ×—×× ×œ×• ×‘×§×‘×•×§. ×™×© ×œ×” ××™× ×—××™× ××”×§×•××§×•× ×”×—×©××œ×™ ×©×”×™×” ×“×•×œ×§ ××¢×¨×‘ ×©×‘×ª. ×”×× ××•×ª×¨ ×œ×©×¤×•×š ×™×©×™×¨×•×ª ×¢×œ ×”×‘×§×‘×•×§?",
            options: [
                "××•×ª×¨, ×›×™ ×–×” ×¦×•×¨×š ×”×ª×™× ×•×§ ×•×”××™× ×›×‘×¨ ×—××™×",
                "××¡×•×¨, ×›×™ ×–×” ×‘×™×©×•×œ ×¢×œ ×™×“×™ ×©×¤×™×›×ª ×¨×•×ª×—×™×Ÿ",
                "××•×ª×¨ ×¨×§ ×× ×ª×©×¤×•×š ×ª×—×™×œ×” ×œ×›×œ×™ ×©× ×™ ×•××– ×œ×‘×§×‘×•×§"
            ],
            correctIndex: 2,
            explanation: "×©×¤×™×›×ª ××™× ×¨×•×ª×—×™× ×™×©×™×¨×•×ª ××›×œ×™ ×¨××©×•×Ÿ ×¢×œ ××–×•×Ÿ × ×—×©×‘×ª ×‘×™×©×•×œ. ×™×© ×œ×©×¤×•×š ×ª×—×™×œ×” ×œ×›×œ×™ ×©× ×™ (×›×•×¡) ×•××– ×œ×‘×§×‘×•×§."
        }
    ];
    
    const issurHeterQuestions = [
        {
            question: "××™×©×” ××¦××” ×—×¨×§ ×§×˜×Ÿ ×‘×›×¨×•×‘ ×©×§× ×ª×”. ×”×× ××•×ª×¨ ×œ×” ×œ×—×ª×•×š ××ª ×”××–×•×¨ ×•×œ×”×©×ª××© ×‘×©××¨ ×”×›×¨×•×‘?",
            options: [
                "××•×ª×¨, ×›×™ ×“×™ ×œ×”×¡×™×¨ ××ª ×”××–×•×¨ ×”× ×’×•×¢",
                "××¡×•×¨, ×¦×¨×™×š ×œ×–×¨×•×§ ××ª ×›×œ ×”×›×¨×•×‘",
                "×ª×œ×•×™ ×‘×¡×•×’ ×”×—×¨×§ - ×× ×–×” ×›×™× ×” ××• ×ª×•×œ×¢×ª"
            ],
            correctIndex: 1,
            explanation: "×›×¨×•×‘ ×©× ××¦× ×‘×• ×—×¨×§ × ×—×©×‘ ×œ××•×—×–×§ ×‘×ª×•×œ×¢×™×, ×•×™×© ×œ×‘×“×•×§ ×”×™×˜×‘ ××• ×œ×–×¨×•×§. ×‘×“×¨×š ×›×œ×œ ×××œ×™×¦×™× ×œ×–×¨×•×§ ×›×™ ×§×©×” ×œ×‘×“×•×§ ×œ×¢×•××§."
        },
        {
            question: "×‘×©×¨ ×¢×•×£ ×©× ×©××¨ ××—×•×¥ ×œ××§×¨×¨ ×œ××©×š 4 ×©×¢×•×ª ×‘×§×™×¥. ×”×× ××•×ª×¨ ×œ××›×•×œ ××•×ª×•?",
            options: [
                "××•×ª×¨, ×›×™ 4 ×©×¢×•×ª ×–×” ×œ× ××¡×¤×™×§ ×–××Ÿ ×œ×”×¤×¡×“",
                "××¡×•×¨ ××¦×“ ×¡×›× ×ª × ×¤×©×•×ª",
                "××•×ª×¨ ×× ××‘×©×œ×™× ×”×™×˜×‘"
            ],
            correctIndex: 1,
            explanation: "×‘×©×¨ ×¢×•×£ ×©× ×©××¨ ×‘×—×•×¥ ×‘×˜××¤×¨×˜×•×¨×” ×’×‘×•×”×” ××¢×œ ×©×¢×ª×™×™× × ×—×©×‘ ×œ××¡×•×›×Ÿ ×‘×¨×™××•×ª×™×ª ×•××¡×•×¨ ×‘××›×™×œ×” (×¡×›× ×ª ×¡×œ××•× ×œ×”)."
        },
        {
            question: "×’×‘×™× ×” ×¦×”×•×‘×” ×©× ××¦××” ×‘×” × ×§×•×“×” ×™×¨×•×§×” ×§×˜× ×” ×©×œ ×¢×•×‘×©. ××” ×”×“×™×Ÿ?",
            options: [
                "××•×ª×¨ ×œ×—×ª×•×š ××ª ×”× ×§×•×“×” ×•×œ××›×•×œ ××ª ×”×©××¨",
                "××¡×•×¨ ×œ××›×•×œ ××ª ×›×œ ×”×’×‘×™× ×”",
                "×ª×œ×•×™ ×‘×’×•×“×œ ×”× ×§×•×“×” - ×× ×§×˜× ×” ×-1 ×¡\"× ××•×ª×¨"
            ],
            correctIndex: 0,
            explanation: "×‘×’×‘×™× ×” ×§×©×”, ××•×ª×¨ ×œ×—×ª×•×š ××ª ××–×•×¨ ×”×¢×•×‘×© ×¢× ××¨×•×•×— ×©×œ ×›-2 ×¡\"× ××¡×‘×™×‘ ×•×œ××›×•×œ ××ª ×”×©××¨."
        },
        {
            question: "×™×¨×§×•×ª ×§×¤×•××™× ×©×”×•×¤×©×¨×• ×‘××§×¨×¨ ×•×”×•×—×–×¨×• ×œ×”×§×¤××”. ×”×× ××•×ª×¨ ×œ××›×•×œ ××•×ª×?",
            options: [
                "××•×ª×¨ ×‘×œ×™ ×‘×¢×™×”",
                "××¡×•×¨, ×›×™ ×”× ×›×‘×¨ ×”×•×¤×©×¨×• ×¤×¢×",
                "××•×ª×¨ ×¨×§ ×× ×œ× ×”×•×¤×©×¨×• ×œ×’××¨×™"
            ],
            correctIndex: 2,
            explanation: "×× ×”×™×¨×§×•×ª ×”×•×¤×©×¨×• ×—×œ×§×™×ª ×‘×œ×‘×“ (×¢×“×™×™×Ÿ ×”×™×• ×’×‘×™×©×™ ×§×¨×—) - ××•×ª×¨ ×œ×”×§×¤×™× ×©×•×‘. ×× ×”×•×¤×©×¨×• ×œ×’××¨×™ - ×œ× ××•××œ×¥ ××‘×—×™× ×” ×‘×¨×™××•×ª×™×ª."
        },
        {
            question: "×ª×‘×©×™×œ ×—×œ×‘×™ ×©× ×ª×¢×¨×‘ ×‘×• ×‘×˜×¢×•×ª ×›×£ ×‘×©×¨×™×ª × ×§×™×™×”. ××” ×”×“×™×Ÿ?",
            options: [
                "×”×ª×‘×©×™×œ ××¡×•×¨ ×‘××›×™×œ×”",
                "×”×ª×‘×©×™×œ ××•×ª×¨, ×¨×§ ×”×›×£ ×¦×¨×™×›×” ×”×›×©×¨",
                "×ª×œ×•×™ ×× ×”×ª×‘×©×™×œ ×”×™×” ×—× ××• ×§×¨"
            ],
            correctIndex: 2,
            explanation: "×× ×”×ª×‘×©×™×œ ×”×™×” ×§×¨ ×•×”×›×£ × ×§×™×™×” - ×”×ª×‘×©×™×œ ××•×ª×¨. ×× ×”×ª×‘×©×™×œ ×”×™×” ×—× (×™×“ ×¡×•×œ×“×ª ×‘×•) - ×™×© ×‘×¢×™×” ×©×œ ×‘×œ×™×¢×ª ×˜×¢× ×•×™×© ×œ×”×ª×™×™×¢×¥ ×¢× ×¨×‘."
        }
    ];
    
    return {
        title: quizType === 'shabbat' ? '×”×œ×›×•×ª ×©×‘×ª' : '××™×¡×•×¨ ×•×”×™×ª×¨',
        questions: quizType === 'shabbat' ? shabbatQuestions : issurHeterQuestions
    };
}

async function createNewAttempt() {
    currentAttemptId = 'local_' + Date.now();
    
    if (firebaseEnabled && db) {
        try {
            const attemptData = {
                user_phone: userData.phone || 'anonymous',
                quiz_type: currentQuiz,
                status: 'active',
                current_q_index: 0,
                answers: {},
                final_score: 0,
                selected_benefit: null,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const docRef = await Promise.race([
                db.collection('attempts').add(attemptData),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Firebase timeout')), 2000))
            ]);
            currentAttemptId = docRef.id;
            console.log('Firebase attempt created:', currentAttemptId);
        } catch (error) {
            console.log('Using local attempt ID (Firebase unavailable):', currentAttemptId);
        }
    }
}

function showQuestion() {
    if (currentQuestionIndex >= quizData.questions.length) {
        stopTimer();
        showScreen('screen-lead-collection');
        return;
    }
    
    const question = quizData.questions[currentQuestionIndex];
    const totalQuestions = quizData.questions.length;
    
    document.getElementById('question-counter').textContent = 
        `×©××œ×” ${currentQuestionIndex + 1} ××ª×•×š ${totalQuestions}`;
    
    const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
    document.getElementById('progress-bar').style.width = `${progress}%`;
    
    document.getElementById('question-text').textContent = question.question;
    
    const answersContainer = document.getElementById('answers-container');
    answersContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'answer-option w-full text-right';
        button.textContent = option;
        button.onclick = () => selectAnswer(index);
        
        if (userAnswers[`q${currentQuestionIndex}`] === index) {
            button.classList.add('selected');
        }
        
        answersContainer.appendChild(button);
    });
    
    updateSidebar();
    startTimer();
    showScreen('screen-question');
}

function updateSidebar() {
    if (!quizData || !quizData.questions) {
        console.log('Quiz data not loaded yet');
        return;
    }
    
    const totalQuestions = quizData.questions.length;
    const productImages = [
        'https://images.unsplash.com/photo-1584308972272-9e4e7685e80f?w=400',
        'https://images.unsplash.com/photo-1610832958506-aa56368176cf?w=400',
        'https://images.unsplash.com/photo-1587563871167-1ee9c731aefb?w=400',
        'https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=400',
        'https://images.unsplash.com/photo-1568702846914-96b305d2aaeb?w=400'
    ];
    
    const productImage = document.getElementById('product-image');
    if (productImage && productImages[currentQuestionIndex]) {
        productImage.src = productImages[currentQuestionIndex];
    }
    
    const progressSteps = document.getElementById('progress-steps');
    if (progressSteps) {
        progressSteps.innerHTML = '';
        
        for (let i = 0; i < totalQuestions; i++) {
            const step = document.createElement('div');
            const hasAnswered = userAnswers.hasOwnProperty(`q${i}`);
            const isCurrent = i === currentQuestionIndex;
            const status = questionAnswerStatus[`q${i}`] || 'empty';
            
            if (hasAnswered && !isCurrent) {
                step.className = 'progress-step completed';
            } else if (isCurrent) {
                step.className = 'progress-step active';
            } else {
                step.className = 'progress-step';
            }
            
            const pieClass = status === 'correct' ? 'complete' : 
                           status === 'wrong' ? 'partial' : 'empty';
            
            step.innerHTML = `
                <div class="progress-pie">
                    <svg width="70" height="70">
                        <circle class="progress-pie-bg" cx="35" cy="35" r="28"></circle>
                        <circle class="progress-pie-fill ${pieClass}" cx="35" cy="35" r="28" 
                                style="stroke-dasharray: ${status === 'correct' ? '175.9' : status === 'wrong' ? '58.6' : '0'} 175.9;"></circle>
                    </svg>
                    <div class="progress-pie-number">${i + 1}</div>
                </div>
            `;
            
            progressSteps.appendChild(step);
        }
    }
}

function startTimer() {
    timeRemaining = 30;
    updateTimerDisplay();
    
    if (questionTimer) {
        clearInterval(questionTimer);
    }
    
    questionTimer = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        
        if (timeRemaining <= 0) {
            clearInterval(questionTimer);
            handleTimeout();
        }
    }, 1000);
}

function stopTimer() {
    if (questionTimer) {
        clearInterval(questionTimer);
        questionTimer = null;
    }
}

function updateTimerDisplay() {
    const timerNumber = document.getElementById('timer-number');
    const timerProgress = document.getElementById('timer-progress');
    
    if (timerNumber) {
        timerNumber.textContent = timeRemaining;
    }
    
    if (timerProgress) {
        const circumference = 2 * Math.PI * 34;
        const progress = (timeRemaining / 30) * circumference;
        timerProgress.style.strokeDasharray = `${progress} ${circumference}`;
        
        timerProgress.classList.remove('normal', 'warning', 'danger');
        if (timeRemaining > 19) {
            timerProgress.classList.add('normal');
        } else if (timeRemaining > 9) {
            timerProgress.classList.add('warning');
        } else {
            timerProgress.classList.add('danger');
        }
    }
}

function handleTimeout() {
    const message = document.createElement('div');
    message.className = 'feedback-message timeout';
    message.innerHTML = `
        <h3 style="font-size: 2.5rem; color: var(--gold); margin-bottom: 1rem;">×”×–××Ÿ × ×’××¨!</h3>
        <p style="font-size: 1.3rem; color: var(--dark-slate);">×’× ××•×¨×” ×”×•×¨××” ×¦×¨×™×š ×œ×¤×¢××™× ×œ×¤×ª×•×— ×¡×¤×¨...<br>×¢×•×‘×¨×™× ×œ×©××œ×” ×”××¢×©×™×ª ×”×‘××”</p>
    `;
    document.body.appendChild(message);
    
    questionAnswerStatus[`q${currentQuestionIndex}`] = 'timeout';
    
    setTimeout(() => {
        message.remove();
        currentQuestionIndex++;
        showQuestion();
    }, 2500);
}

function showFeedbackMessage(isCorrect) {
    const messages = {
        correct: [
            '×•×•××•! ×¤×¡×§×ª × ×›×•×Ÿ!',
            '××¦×•×™×™×Ÿ! ×”×›×¨×¢×” ××“×•×™×§×ª!',
            '×™×¤×”! ×¤×¡×™×§×” ××•×©×œ××ª!',
            '××¢×•×œ×”! ×”×›×¨×¢×ª ×›×”×œ×›×”!'
        ],
        wrong: [
            '××××... ×œ× ×‘×“×™×•×§',
            '×”××... ×™×© ×›××Ÿ ××§×•× ×œ×¢×™×•×Ÿ',
            '×œ× ×‘×“×™×•×§... ×‘×•× × ×‘×“×•×§ ×©×•×‘',
            '×”×¤×¡×™×§×” ×©×•× ×” ××¢×˜...'
        ]
    };
    
    const messageArray = isCorrect ? messages.correct : messages.wrong;
    const randomMessage = messageArray[Math.floor(Math.random() * messageArray.length)];
    
    const message = document.createElement('div');
    message.className = `feedback-message ${isCorrect ? 'correct' : 'wrong'}`;
    message.innerHTML = `
        <h3 style="font-size: 3rem; margin-bottom: 0.5rem;">${isCorrect ? 'âœ“' : 'âœ—'}</h3>
        <p style="font-size: 1.8rem; color: ${isCorrect ? '#22c55e' : '#f59e0b'}; font-weight: bold; margin-bottom: 0.5rem;">${randomMessage}</p>
        <p style="font-size: 1.2rem; color: var(--dark-slate);">${isCorrect ? '×¢×•×‘×¨×™× ×œ×©××œ×” ×”××¢×©×™×ª ×”×‘××”' : '×‘×•× × ×¨××” ××ª ×”×©××œ×” ×”×‘××”'}</p>
    `;
    document.body.appendChild(message);
    
    setTimeout(() => message.remove(), 1500);
}

function createConfetti() {
    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * window.innerWidth + 'px';
            confetti.style.top = '-10px';
            confetti.style.background = ['#D4B182', '#b89968', '#e8d4b8'][Math.floor(Math.random() * 3)];
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 1000);
        }, i * 30);
    }
}

async function selectAnswer(answerIndex) {
    stopTimer();
    
    userAnswers[`q${currentQuestionIndex}`] = answerIndex;
    const correctAnswer = quizData.questions[currentQuestionIndex].correctIndex;
    const isCorrect = answerIndex === correctAnswer;
    
    questionAnswerStatus[`q${currentQuestionIndex}`] = isCorrect ? 'correct' : 'wrong';
    
    const buttons = document.querySelectorAll('.answer-option');
    buttons.forEach((btn, idx) => {
        btn.classList.remove('selected');
        if (idx === answerIndex) {
            btn.classList.add('selected');
        }
    });
    
    showFeedbackMessage(isCorrect);
    
    if (isCorrect) {
        createConfetti();
    } else {
        const answersContainer = document.getElementById('answers-container');
        answersContainer.classList.add('shake');
        setTimeout(() => answersContainer.classList.remove('shake'), 400);
    }
    
    saveToLocalStorage();
    await updateAttemptInDB();
    updateSidebar();
    
    setTimeout(() => {
        currentQuestionIndex++;
        showQuestion();
    }, 1600);
}

async function updateAttemptInDB() {
    if (!firebaseEnabled || !db || !currentAttemptId || currentAttemptId.startsWith('local_')) return;
    
    try {
        await db.collection('attempts').doc(currentAttemptId).update({
            current_q_index: currentQuestionIndex,
            answers: userAnswers,
            updated_at: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error updating attempt:', error);
    }
}

function showNeedReview() {
    document.getElementById('screen-need-review').classList.remove('hidden');
}

function closeNeedReview() {
    document.getElementById('screen-need-review').classList.add('hidden');
}

document.getElementById('pause-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = document.getElementById('pause-name').value;
    const contact = document.getElementById('pause-contact').value;
    
    userData.name = name;
    userData.phone = contact;
    
    await saveUserData();
    
    if (firebaseEnabled && db && currentAttemptId && !currentAttemptId.startsWith('local_')) {
        try {
            await db.collection('attempts').doc(currentAttemptId).update({
                user_phone: contact,
                status: 'paused',
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (error) {
            console.error('Error pausing attempt:', error);
        }
    }
    
    const resumeLink = `${window.location.origin}${window.location.pathname}?resume=true&phone=${encodeURIComponent(contact)}&quiz=${currentQuiz}`;
    
    alert(`×”×§×™×©×•×¨ × ×©××¨!\n\n×”×§×™×©×•×¨ ×©×œ×š ×œ×”××©×š ×”××‘×—×Ÿ:\n${resumeLink}\n\n×”×§×™×©×•×¨ × ×©×œ×— ×’× ×œ××™×™×œ/×•×•××˜×¡××¤ ×©×”×–× ×ª.`);
    
    closeNeedReview();
});

async function saveUserData() {
    if (!userData.phone || !firebaseEnabled || !db) return;
    
    try {
        await db.collection('users').doc(userData.phone).set({
            full_name: userData.name,
            email: userData.email || '',
            phone: userData.phone,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
    } catch (error) {
        console.error('Error saving user:', error);
    }
}

async function resumeQuizFromPause(phone, quizType) {
    if (!firebaseEnabled || !db) {
        await loadQuizData(quizType);
        await createNewAttempt();
        showQuestion();
        return;
    }
    
    try {
        const attemptsQuery = await db.collection('attempts')
            .where('user_phone', '==', phone)
            .where('quiz_type', '==', quizType)
            .where('status', '==', 'paused')
            .orderBy('created_at', 'desc')
            .limit(1)
            .get();
        
        if (!attemptsQuery.empty) {
            const attemptDoc = attemptsQuery.docs[0];
            const attemptData = attemptDoc.data();
            
            currentAttemptId = attemptDoc.id;
            currentQuestionIndex = attemptData.current_q_index;
            userAnswers = attemptData.answers || {};
            
            await loadQuizData(quizType);
            
            if (firebaseEnabled && db) {
                await db.collection('attempts').doc(currentAttemptId).update({
                    status: 'active',
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            showQuestion();
        } else {
            await loadQuizData(quizType);
            await createNewAttempt();
            showQuestion();
        }
    } catch (error) {
        console.error('Error resuming quiz:', error);
        await loadQuizData(quizType);
        await createNewAttempt();
        showQuestion();
    }
}

document.getElementById('lead-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    userData.name = document.getElementById('lead-name').value;
    userData.phone = document.getElementById('lead-phone').value;
    userData.email = document.getElementById('lead-email').value;
    
    await saveUserData();
    
    const score = calculateScore();
    
    if (firebaseEnabled && db && currentAttemptId && !currentAttemptId.startsWith('local_')) {
        try {
            await db.collection('attempts').doc(currentAttemptId).update({
                user_phone: userData.phone,
                status: 'completed',
                final_score: score,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (error) {
            console.error('Error completing attempt:', error);
        }
    }
    
    await updateGlobalStats(score);
    
    showResults(score);
});

function calculateScore() {
    let correct = 0;
    const totalQuestions = quizData.questions.length;
    
    for (let i = 0; i < totalQuestions; i++) {
        const userAnswer = userAnswers[`q${i}`];
        const correctAnswer = quizData.questions[i].correctIndex;
        
        if (userAnswer === correctAnswer) {
            correct++;
        }
    }
    
    return Math.round((correct / totalQuestions) * 100);
}

async function updateGlobalStats(score) {
    if (!firebaseEnabled || !db) return;
    
    try {
        const statsRef = db.collection('stats').doc('global_stats');
        const fieldName = currentQuiz === 'shabbat' ? 'total_shabbat_takers' : 'total_issur_heter_takers';
        const avgFieldName = currentQuiz === 'shabbat' ? 'avg_score_shabbat' : 'avg_score_issur_heter';
        
        await db.runTransaction(async (transaction) => {
            const statsDoc = await transaction.get(statsRef);
            
            if (!statsDoc.exists) {
                transaction.set(statsRef, {
                    [fieldName]: 1,
                    [avgFieldName]: score,
                    hard_question_errors: 0
                });
            } else {
                const data = statsDoc.data();
                const currentTotal = data[fieldName] || 0;
                const currentAvg = data[avgFieldName] || 0;
                
                const newTotal = currentTotal + 1;
                const newAvg = ((currentAvg * currentTotal) + score) / newTotal;
                
                transaction.update(statsRef, {
                    [fieldName]: newTotal,
                    [avgFieldName]: Math.round(newAvg)
                });
            }
        });
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

async function showResults(score) {
    document.getElementById('final-score').textContent = `${score}%`;
    
    const resultsHeader = document.getElementById('results-header');
    const socialStats = document.getElementById('social-stats');
    
    if (score >= 80) {
        resultsHeader.innerHTML = `
            <h2 class="text-4xl font-bold mb-2 text-gold">
                ×™×© ×œ×š ×¤×•×˜× ×¦×™××œ ×œ×”×•×¨××”! ğŸ†
            </h2>
        `;
        
        socialStats.innerHTML = `
            <p class="mb-3 text-lg" style="color: var(--dark-slate);">
                <strong class="text-gold">×”×’×¨×£ ×”×—×‘×¨×ª×™:</strong> ×”× ×ª×•× ×™× ××¨××™× ×©××ª×” × ××¦× ×‘-Top 10% ×©×œ ×”× ×‘×—× ×™×.
            </p>
            <p class="mb-3 text-lg" style="color: var(--dark-slate);">
                ×‘×¢×•×“ ×”×¨×•×‘ ×”××•×—×œ×˜ (×›-70%) ×”×ª×§×©×• ×œ×”×›×¨×™×¢ ×‘×©××œ×” ×”××¢×©×™×ª, ××ª×” ×™×“×¢×ª ×œ×›×•×•×Ÿ ×œ×××™×ª×” ×©×œ ×ª×•×¨×”.
                ×‘×¦×™×‘×•×¨ ×©×œ× ×•, ×™×“×¢ ×›×–×” ×”×•× ××—×¨×™×•×ª.
            </p>
            <p class="font-bold text-lg" style="color: #15803d;">
                âœ… ×¡×˜×˜×•×¡ ×–×›×™×™×”: × ×›× ×¡×ª ××•×˜×•××˜×™×ª ×œ×”×’×¨×œ×ª ×”×¢× ×§ ×¢×œ ×©×‘×ª '×’×•×œ×“×™×¡' ×§×•××¤×œ×˜!
            </p>
        `;
    } else {
        resultsHeader.innerHTML = `
            <h2 class="text-3xl font-bold mb-2 text-gold">
                ××ª×” ×‘×—×‘×¨×” ×˜×•×‘×”.
            </h2>
        `;
        
        socialStats.innerHTML = `
            <p class="mb-3 text-lg" style="color: var(--dark-slate);">
                <strong class="text-gold">×”×’×¨×£ ×”×—×‘×¨×ª×™:</strong> ××”× ×ª×•× ×™× ×©×œ× ×• ×¢×•×œ×” ×›×™ 64% ××”× ×‘×—× ×™× ×”×ª×œ×‘×˜×• ×‘×“×™×•×§ ×‘××•×ª×Ÿ × ×§×•×“×•×ª ××¢×©×™×•×ª ×›××•×š.
            </p>
            <p class="mb-3 text-lg" style="color: var(--dark-slate);">
                ×–×” ×œ× ××¢×™×“ ×¢×œ ×—×•×¡×¨ ×™×“×¢, ××œ× ×¢×œ ×”××ª×’×¨ ×”×’×“×•×œ ×©×‘××¢×‘×¨ ×"×œ×™××•×“ ×”×ª×™××•×¨×™×”" ×œ"×¤×¡×™×§×” ×œ××¢×©×”".
                ×‘×“×™×•×§ ×‘×’×œ×œ ×©×”× ×ª×•×Ÿ ×”×–×” ×›×•××‘ ×œ× ×•, ×”×§×× ×• ××ª "×§× ×™×™×Ÿ ×”×•×¨××”" - ×œ×ª×ª ×œ×š ××ª ×”×©×™×˜×” ×•×”×‘×™×˜×—×•×Ÿ ×œ×”×›×¨×™×¢.
            </p>
            <p class="font-bold text-lg" style="color: #2563eb;">
                âœ… ×¡×˜×˜×•×¡ ×–×›×™×™×”: ×¦×‘×¨×ª × ×™×§×•×“ ×”××–×›×” ××•×ª×š ×‘×”×©×ª×ª×¤×•×ª ×‘×”×’×¨×œ×ª ×”× ×™×—×•××™× ×¢×œ ××œ×’×•×ª ×œ×™××•×“×™×.
            </p>
        `;
    }
    
    showScreen('screen-results');
}

document.getElementById('benefit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const selectedBenefit = document.querySelector('input[name="benefit"]:checked').value;
    
    if (firebaseEnabled && db && currentAttemptId && !currentAttemptId.startsWith('local_')) {
        try {
            await db.collection('attempts').doc(currentAttemptId).update({
                selected_benefit: selectedBenefit,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (error) {
            console.error('Error saving benefit:', error);
        }
    }
    
    await sendToCRM(selectedBenefit);
    
    document.getElementById('benefit-form').classList.add('hidden');
    document.getElementById('final-actions').classList.remove('hidden');
});

async function sendToCRM(benefit) {
    const webhookURL = 'https://hook.eu2.make.com/ibpdetf3fl9e83d2tdhh4ba2sdsjlwdq';
    
    const score = calculateScore();
    
    const payload = [{
        form: {
            name: 'Kinyan Horaah Quiz Results',
            type: 'quiz_completion'
        },
        fields: {
            name: userData.name,
            phone: userData.phone,
            email: userData.email,
            quiz_type: currentQuiz,
            score: score,
            selected_benefit: benefit
        },
        meta: {
            timestamp: new Date().toISOString(),
            source: 'kinyan-horaah-quiz',
            user_agent: navigator.userAgent
        }
    }];
    
    try {
        await fetch(webhookURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        console.log('Data sent to CRM successfully');
    } catch (error) {
        console.error('Error sending to CRM:', error);
    }
}

async function downloadPDF() {
    try {
        const pdfContent = document.getElementById('pdf-content');
        const score = calculateScore();
        
        document.getElementById('pdf-user-info').innerHTML = `
            <div style="border-bottom: 2px solid #D4B182; padding-bottom: 15px;">
                <p style="font-size: 18px; color: #32373c;"><strong>×©×:</strong> ${userData.name}</p>
                <p style="font-size: 18px; color: #32373c;"><strong>×˜×œ×¤×•×Ÿ:</strong> ${userData.phone}</p>
                <p style="font-size: 18px; color: #32373c;"><strong>××™×™×œ:</strong> ${userData.email}</p>
            </div>
        `;
        
        document.getElementById('pdf-score').innerHTML = `
            <div style="background: linear-gradient(135deg, #b89968, #D4B182); padding: 30px; border-radius: 12px; text-align: center;">
                <h2 style="color: white; font-size: 48px; margin: 0;">${score}%</h2>
                <p style="color: white; font-size: 20px; margin: 10px 0 0 0;">×”×¦×™×•×Ÿ ×©×œ×š</p>
            </div>
        `;
        
        let questionsHTML = '<h3 style="color: #D4B182; font-size: 24px; margin-bottom: 20px;">×©××œ×•×ª ×•×ª×©×•×‘×•×ª:</h3>';
        
        quizData.questions.forEach((q, index) => {
            const userAnswer = userAnswers[`q${index}`];
            const isCorrect = userAnswer === q.correctIndex;
            
            questionsHTML += `
                <div style="margin-bottom: 30px; padding: 20px; background: #fdfbf8; border-right: 4px solid ${isCorrect ? '#22c55e' : '#ef4444'}; border-radius: 8px;">
                    <h4 style="color: #32373c; font-size: 18px; margin-bottom: 10px;">×©××œ×” ${index + 1}:</h4>
                    <p style="color: #32373c; font-size: 16px; margin-bottom: 15px;">${q.question}</p>
                    
                    <p style="color: #32373c; margin-bottom: 5px;"><strong>×”×ª×©×•×‘×” ×©×œ×š:</strong> ${q.options[userAnswer] || '×œ× × ×¢× ×ª×”'}</p>
                    <p style="color: #22c55e; margin-bottom: 5px;"><strong>×”×ª×©×•×‘×” ×”× ×›×•× ×”:</strong> ${q.options[q.correctIndex]}</p>
                    
                    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">
                        <p style="color: #32373c; font-size: 14px; margin: 0;"><strong>×”×¡×‘×¨:</strong> ${q.explanation}</p>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('pdf-questions').innerHTML = questionsHTML;
        
        pdfContent.classList.remove('hidden');
        
        const canvas = await html2canvas(pdfContent, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        });
        
        pdfContent.classList.add('hidden');
        
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        const pdfBlob = pdf.output('blob');
        const pdfBase64 = pdf.output('dataurlstring');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        window.open(pdfUrl, '_blank');
        
        const pdfWebhookURL = 'https://hook.eu2.make.com/5hpmbhxrti8kzmjw29zp39a6dp9kacje';
        
        fetch(pdfWebhookURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: userData.email,
                name: userData.name,
                phone: userData.phone,
                quiz_type: currentQuiz === 'shabbat' ? '×”×œ×›×•×ª ×©×‘×ª' : '××™×¡×•×¨ ×•×”×™×ª×¨',
                score: score,
                pdf_base64: pdfBase64,
                pdf_filename: `×§× ×™×™×Ÿ_×”×•×¨××”_${userData.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`
            })
        }).catch(error => {
            console.error('Error sending PDF to email:', error);
        });
        
        alert('×”×§×•×‘×¥ × ×¤×ª×— ×‘×—×œ×•×Ÿ ×—×“×© ×•×’× × ×©×œ×— ×œ××™×™×œ ×©×œ×š!');
    } catch (error) {
        console.error('Error generating PDF:', error);
        alert('××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×§×•×‘×¥. ×× × × ×¡×” ×©×•×‘.');
    }
}

function restartQuiz() {
    const otherQuiz = currentQuiz === 'shabbat' ? 'issur_heter' : 'shabbat';
    currentQuiz = null;
    currentQuestionIndex = 0;
    userAnswers = {};
    currentAttemptId = null;
    questionAnswerStatus = {};
    
    showScreen('screen-lobby');
    
    setTimeout(() => {
        startQuiz(otherQuiz);
    }, 100);
}

function saveToLocalStorage() {
    const state = {
        currentQuiz,
        currentQuestionIndex,
        userAnswers,
        currentAttemptId,
        userData
    };
    localStorage.setItem('quizState', JSON.stringify(state));
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem('quizState');
    if (saved) {
        try {
            const state = JSON.parse(saved);
            currentQuiz = state.currentQuiz;
            currentQuestionIndex = state.currentQuestionIndex;
            userAnswers = state.userAnswers || {};
            currentAttemptId = state.currentAttemptId;
            userData = state.userData || { phone: null, name: null, email: null };
        } catch (error) {
            console.error('Error loading from localStorage:', error);
        }
    }
}

window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const resumeMode = urlParams.get('resume');
    
    if (resumeMode) {
        const phone = urlParams.get('phone');
        const quiz = urlParams.get('quiz');
        if (phone && quiz) {
            startQuiz(quiz);
        }
    } else {
        loadFromLocalStorage();
    }
});

const radioLabels = document.querySelectorAll('label:has(input[type="radio"])');
radioLabels.forEach(label => {
    const radio = label.querySelector('input[type="radio"]');
    if (radio) {
        radio.addEventListener('change', () => {
            radioLabels.forEach(l => {
                l.style.borderColor = '#e5e7eb';
                l.style.background = 'white';
            });
            if (radio.checked) {
                label.style.borderColor = 'var(--gold)';
                label.style.background = 'linear-gradient(135deg, rgba(212, 177, 130, 0.1), rgba(212, 177, 130, 0.2))';
            }
        });
    }
});
    </script>
</body>
</html>
