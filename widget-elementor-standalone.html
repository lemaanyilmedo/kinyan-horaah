<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§× ×™×™×Ÿ ×”×•×¨××” - ××ª×’×¨ ×”×¤×¡×™×§×”</title>
    
    <!-- External Dependencies (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* ============================================
           CSS VARIABLES & RESET
           ============================================ */
        :root {
            --gold: #D4B182;
            --dark-slate: #32373c;
            --light-cream: #fdfbf8;
            --gold-dark: #b89968;
            --gold-light: #e8d4b8;
        }
        
        /* Widget Container - inherits fonts from parent site */
        .kinyan-widget-container {
            font-family: inherit !important;
            color: var(--dark-slate);
            direction: rtl;
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .kinyan-widget-container * {
            box-sizing: border-box;
        }
        
        /* Full Screen Container */
        .kinyan-full-screen {
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
            width: 100%;
            background: linear-gradient(rgba(50, 55, 60, 0.88), rgba(50, 55, 60, 0.92)),
                        url('https://www.kinyanhoraah.co.il/wp-content/uploads/2026/01/WhatsApp-Image-2026-01-22-at-18.00.10.jpeg') center/cover;
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
        }
        
        /* Content Glass Effect */
        .kinyan-content-glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 1100px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Full Width Content */
        .kinyan-full-width {
            width: 100%;
            padding: 1.5rem 5%;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .kinyan-full-width.scrollable {
            overflow-y: auto;
            justify-content: flex-start;
        }
        
        /* Hero Content */
        .kinyan-hero {
            text-align: center;
            color: white;
            width: 100%;
        }
        
        .kinyan-hero-title {
            font-size: clamp(4rem, 6vw, 6rem);
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.1;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            color: white;
        }
        
        .kinyan-hero-subtitle {
            font-size: clamp(2.5rem, 3.5vw, 3.5rem);
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .kinyan-hero-description {
            font-size: clamp(1.3rem, 1.8vw, 1.8rem);
            margin-bottom: 1.5rem;
            opacity: 0.95;
            line-height: 1.5;
            color: white;
        }
        
        /* Buttons */
        .kinyan-btn-primary {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            color: white;
            padding: 1.8rem 3rem;
            border-radius: 15px;
            border: none;
            font-weight: 700;
            font-size: clamp(1.5rem, 2vw, 2rem);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(212, 177, 130, 0.5);
            display: block;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            min-height: 70px;
        }
        
        .kinyan-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212, 177, 130, 0.7);
        }
        
        .kinyan-btn-secondary {
            background: rgba(50, 55, 60, 0.85);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1.2rem 2.5rem;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
            font-size: clamp(1.2rem, 1.5vw, 1.8rem);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .kinyan-btn-secondary:hover {
            background: #454a50;
            transform: translateY(-2px);
        }
        
        /* Loading Overlay */
        .kinyan-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        
        .kinyan-loading.hidden {
            display: none;
        }
        
        .kinyan-loading-content {
            text-align: center;
            color: white;
        }
        
        .kinyan-loading-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(212, 177, 130, 0.3);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: kinyan-spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        
        @keyframes kinyan-spin {
            to { transform: rotate(360deg); }
        }
        
        .kinyan-loading-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gold);
        }
        
        /* Version Badge */
        .kinyan-version {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(212, 177, 130, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* Quiz Type Badge */
        .kinyan-quiz-badge {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(212, 177, 130, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .kinyan-quiz-badge.hidden {
            display: none;
        }
        
        /* Progress Circles */
        .kinyan-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            margin: 1.5rem 0;
            position: relative;
        }
        
        .kinyan-progress-line {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 3px;
            background: linear-gradient(to left, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.3) 100%);
            z-index: 0;
        }
        
        .kinyan-progress-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            color: white;
            z-index: 1;
            flex: 1;
            max-width: 60px;
            margin: 0 auto;
        }
        
        .kinyan-progress-circle svg {
            position: absolute;
            top: -4px;
            left: -4px;
            width: 68px;
            height: 68px;
            transform: rotate(-90deg);
            pointer-events: none;
        }
        
        .kinyan-progress-circle .circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 4;
        }
        
        .kinyan-progress-circle .circle-progress {
            fill: none;
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dasharray 0.6s ease;
        }
        
        .kinyan-progress-circle.active {
            background: var(--gold);
            color: white;
            box-shadow: 0 0 0 4px rgba(212, 177, 130, 0.3);
            animation: kinyan-pulse 2s infinite;
            transform: scale(1.15);
        }
        
        .kinyan-progress-circle.correct .circle-progress {
            stroke: #22c55e;
        }
        
        .kinyan-progress-circle.wrong .circle-progress {
            stroke: #f59e0b;
        }
        
        .kinyan-progress-circle.timeout .circle-progress {
            stroke: #94a3b8;
        }
        
        @keyframes kinyan-pulse {
            0%, 100% { box-shadow: 0 0 0 4px rgba(212, 177, 130, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(212, 177, 130, 0.1); }
        }
        
        /* Question Styles */
        .kinyan-question-header {
            text-align: center;
            font-size: clamp(1.5rem, 2vw, 2.5rem);
            color: var(--gold);
            font-weight: 700;
            margin-bottom: 1rem;
            padding: 1rem 2rem;
            background: rgba(212, 177, 130, 0.2);
            backdrop-filter: blur(10px);
            border-bottom: 3px solid var(--gold);
        }
        
        .kinyan-question-text {
            font-size: clamp(2.5rem, 4vw, 5rem);
            font-weight: 700;
            line-height: 1.3;
            color: white;
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.7);
            text-align: right;
            direction: rtl;
            margin-bottom: 2rem;
        }
        
        /* Timer */
        .kinyan-timer {
            width: 120px;
            height: 120px;
            position: relative;
            flex-shrink: 0;
        }
        
        .kinyan-timer svg {
            transform: rotate(-90deg);
        }
        
        .kinyan-timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        /* Answer Options */
        .kinyan-answers {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .kinyan-answer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(1.3rem, 1.7vw, 1.8rem);
            font-weight: 600;
            text-align: right;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .kinyan-answer:hover {
            transform: translateX(-5px);
            border-color: var(--gold);
            box-shadow: 0 6px 20px rgba(212, 177, 130, 0.4);
        }
        
        .kinyan-answer.selected {
            border-color: var(--gold);
            background: rgba(212, 177, 130, 0.2);
        }
        
        /* Form Styles */
        .kinyan-form-input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid rgba(212, 177, 130, 0.3);
            border-radius: 10px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: white;
            color: var(--dark-slate);
        }
        
        .kinyan-form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 177, 130, 0.2);
        }
        
        /* Hidden Class */
        .hidden {
            display: none !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .kinyan-content-glass {
                padding: 2rem 1.5rem;
                border-radius: 20px;
            }
            
            .kinyan-full-width {
                padding: 1rem 3%;
            }
            
            .kinyan-hero-title {
                font-size: clamp(2.5rem, 8vw, 4rem);
            }
            
            .kinyan-question-text {
                font-size: clamp(1.8rem, 5vw, 3rem);
            }
        }
    </style>
</head>
<body>
    <!-- Widget Container -->
    <div class="kinyan-widget-container" id="kinyan-app">
        
        <!-- Version Badge -->
        <div class="kinyan-version">×’×™×¨×¡×” 26-Widget</div>
        
        <!-- Quiz Type Badge -->
        <div id="quiz-type-badge" class="kinyan-quiz-badge hidden"></div>
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="kinyan-loading hidden">
            <div class="kinyan-loading-content">
                <div class="kinyan-loading-spinner"></div>
                <div class="kinyan-loading-text">×˜×•×¢×Ÿ...</div>
            </div>
        </div>
        
        <!-- Screen: Lobby -->
        <div id="screen-lobby" class="kinyan-full-screen">
            <div class="kinyan-full-width">
                <div class="kinyan-hero">
                    <h1 class="kinyan-hero-title">×§× ×™×™×Ÿ ×”×•×¨××”</h1>
                    <p class="kinyan-hero-subtitle">×”×¤×•×¡×§ ×©×‘×š</p>
                    <p class="kinyan-hero-description">
                        ××ª×’×¨ ×”×¤×¡×™×§×” ×”××¢×©×™×ª - ×‘×—×Ÿ ××ª ×¢×¦××š ×‘×©××œ×•×ª ×”×œ×›×ª×™×•×ª ××¢×©×™×•×ª
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 2rem; margin-top: 3rem; align-items: center;">
                        <button onclick="kinyanStartQuiz('shabbat')" class="kinyan-btn-primary">
                            ğŸ•¯ï¸ ×”×ª×—×œ ××ª×’×¨ - ×”×œ×›×•×ª ×©×‘×ª
                        </button>
                        <button onclick="kinyanStartQuiz('issur_heter')" class="kinyan-btn-primary">
                            ğŸ½ï¸ ×”×ª×—×œ ××ª×’×¨ - ××™×¡×•×¨ ×•×”×™×ª×¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen: Question -->
        <div id="screen-question" class="kinyan-full-screen hidden">
            <div class="kinyan-full-width scrollable">
                <div class="kinyan-question-header" id="question-header">×©××œ×” 1 ××ª×•×š 10</div>
                
                <!-- Progress Circles -->
                <div class="kinyan-progress">
                    <div class="kinyan-progress-line"></div>
                    <div id="progress-circles"></div>
                </div>
                
                <!-- Question Container -->
                <div style="display: flex; align-items: flex-start; gap: 2rem; margin-bottom: 1.5rem;">
                    <div class="kinyan-question-text" id="question-text"></div>
                    
                    <!-- Timer -->
                    <div class="kinyan-timer">
                        <svg width="120" height="120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="8"/>
                            <circle id="timer-circle" cx="60" cy="60" r="54" fill="none" stroke="var(--gold)" stroke-width="8" 
                                    stroke-dasharray="339.292" stroke-dashoffset="0" stroke-linecap="round"/>
                        </svg>
                        <div class="kinyan-timer-text" id="timer-display">60</div>
                    </div>
                </div>
                
                <!-- Answer Options -->
                <div id="answers-container" class="kinyan-answers"></div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 2rem; margin-top: 2rem;">
                    <button onclick="kinyanShowNeedReview()" class="kinyan-btn-secondary" style="flex: 1;">
                        ×©× ×™×”, ×× ×™ ×¨×•×¦×” ×œ×‘×“×•×§ ×¨×’×¢
                    </button>
                    <button onclick="kinyanNextQuestion()" class="kinyan-btn-secondary" style="flex: 1;">
                        ×©××œ×” ×”×‘××” â†
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Screen: Results -->
        <div id="screen-results" class="kinyan-full-screen hidden">
            <div class="kinyan-content-glass">
                <div style="text-align: center;">
                    <div id="results-header"></div>
                    <div id="social-stats" style="margin: 2rem 0;"></div>
                    <button onclick="kinyanShowScreen('screen-lobby')" class="kinyan-btn-primary" style="margin-top: 2rem;">
                        ×—×–×¨×” ×œ××¡×š ×”×‘×™×ª
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- ============================================
         JAVASCRIPT CODE
         ============================================ -->
    <script>
    (function() {
        'use strict';
        
        // Version
        const APP_VERSION = 'v26-Widget';
        console.log(`ğŸš€ Kinyan Horaah Quiz Widget ${APP_VERSION}`);
        
        // CSV URLs
        const CSV_URLS = {
            shabbat: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTms4MIHYC7w0sRgy0I_4hg1967D_snpA9BUcT2NTwuZRxbRb_mzkZ6kScFXLfJGbT_t3cDXTPBxomc/pub?gid=0&single=true&output=tsv',
            issur_heter: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTms4MIHYC7w0sRgy0I_4hg1967D_snpA9BUcT2NTwuZRxbRb_mzkZ6kScFXLfJGbT_t3cDXTPBxomc/pub?gid=1643191626&single=true&output=tsv'
        };
        
        const QUESTIONS_TO_SHOW = 10;
        
        // Firebase Configuration
        let firebaseConfig = {
            apiKey: "AIzaSyC1g2vKVbO9hQReaNJ2R3CaLX_0Lc3HwCQ",
            authDomain: "kinyan-26210.firebaseapp.com",
            projectId: "kinyan-26210",
            storageBucket: "kinyan-26210.firebasestorage.app",
            messagingSenderId: "443697566818",
            appId: "1:443697566818:web:ed548251d67df16e6bed3b",
            measurementId: "G-HM09TZR0HW"
        };
        
        let db = null;
        let firebaseEnabled = false;
        
        // Initialize Firebase
        try {
            if (typeof firebase !== 'undefined' && firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                db.settings({
                    experimentalForceLongPolling: true
                });
                firebaseEnabled = true;
                console.log('Firebase initialized successfully with Long Polling');
            } else {
                console.log('Firebase not configured - running in local mode');
            }
        } catch (error) {
            console.log('Firebase initialization failed - running in local mode:', error);
            firebaseEnabled = false;
        }
        
        // State Variables
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let currentAttemptId = null;
        let quizData = null;
        let userData = {
            phone: null,
            email: null,
            name: null
        };
        let timerInterval = null;
        let timeRemaining = 60;
        let csvCache = {};
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function kinyanShowLoading(text = '×˜×•×¢×Ÿ...') {
            const overlay = document.getElementById('loading-overlay');
            const textEl = overlay.querySelector('.kinyan-loading-text');
            textEl.textContent = text;
            overlay.classList.remove('hidden');
        }
        
        function kinyanHideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        window.kinyanShowScreen = function(screenId) {
            const screens = ['screen-lobby', 'screen-question', 'screen-results'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === screenId) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                }
            });
        };
        
        // ============================================
        // QUIZ LOGIC
        // ============================================
        
        window.kinyanStartQuiz = async function(quizType) {
            currentQuiz = quizType;
            currentQuestionIndex = 0;
            userAnswers = {};
            
            // Update quiz badge
            const badge = document.getElementById('quiz-type-badge');
            badge.textContent = quizType === 'shabbat' ? 'ğŸ•¯ï¸ ×”×œ×›×•×ª ×©×‘×ª' : 'ğŸ½ï¸ ××™×¡×•×¨ ×•×”×™×ª×¨';
            badge.classList.remove('hidden');
            
            kinyanShowLoading('×˜×•×¢×Ÿ ×©××œ×•×ª...');
            
            try {
                await kinyanLoadQuizData(quizType);
                kinyanHideLoading();
                kinyanShowQuestion();
                kinyanShowScreen('screen-question');
            } catch (error) {
                kinyanHideLoading();
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×©××œ×•×ª. ×× × × ×¡×” ×©×•×‘.');
                kinyanShowScreen('screen-lobby');
            }
        };
        
        async function kinyanLoadQuizData(quizType) {
            if (csvCache[quizType]) {
                quizData = csvCache[quizType];
                return;
            }
            
            try {
                const csvUrl = CSV_URLS[quizType];
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                quizData = kinyanParseCSV(csvText, quizType);
                csvCache[quizType] = quizData;
                console.log('Questions loaded successfully');
            } catch (error) {
                console.error('Error loading CSV:', error);
                throw error;
            }
        }
        
        function kinyanParseCSV(csvText, quizType) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const allQuestions = [];
            
            for (let i = 1; i < lines.length; i++) {
                const parts = kinyanParseCSVLine(lines[i]);
                if (parts.length >= 8) {
                    const question = {
                        question: parts[0],
                        options: [parts[1], parts[2], parts[3], parts[4]],
                        correctIndex: parseInt(parts[5]) - 1,
                        partialIndex: parts[6] ? parseInt(parts[6]) - 1 : -1,
                        explanation: parts[7] || ''
                    };
                    allQuestions.push(question);
                }
            }
            
            // Shuffle and select questions
            const shuffled = allQuestions.sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, QUESTIONS_TO_SHOW);
            
            return {
                title: quizType === 'shabbat' ? '×”×œ×›×•×ª ×©×‘×ª' : '××™×¡×•×¨ ×•×”×™×ª×¨',
                questions: selected
            };
        }
        
        function kinyanParseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '\t' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else if (char === '"') {
                    inQuotes = !inQuotes;
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function kinyanShowQuestion() {
            if (!quizData || currentQuestionIndex >= quizData.questions.length) {
                kinyanShowResults();
                return;
            }
            
            const question = quizData.questions[currentQuestionIndex];
            
            // Update header
            document.getElementById('question-header').textContent = 
                `×©××œ×” ${currentQuestionIndex + 1} ××ª×•×š ${quizData.questions.length}`;
            
            // Update question text
            document.getElementById('question-text').textContent = question.question;
            
            // Update progress circles
            kinyanUpdateProgressCircles();
            
            // Update answers
            const answersContainer = document.getElementById('answers-container');
            answersContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'kinyan-answer';
                answerDiv.textContent = option;
                answerDiv.onclick = () => kinyanSelectAnswer(index);
                answersContainer.appendChild(answerDiv);
            });
            
            // Start timer
            kinyanStartTimer();
        }
        
        function kinyanUpdateProgressCircles() {
            const container = document.getElementById('progress-circles');
            container.innerHTML = '';
            
            for (let i = 0; i < quizData.questions.length; i++) {
                const circle = document.createElement('div');
                circle.className = 'kinyan-progress-circle';
                circle.innerHTML = `
                    <svg>
                        <circle class="circle-bg" cx="34" cy="34" r="30"/>
                        <circle class="circle-progress" cx="34" cy="34" r="30" 
                                stroke-dasharray="0 188.5"/>
                    </svg>
                    ${i + 1}
                `;
                
                if (i === currentQuestionIndex) {
                    circle.classList.add('active');
                } else if (userAnswers[`q${i}`] !== undefined) {
                    const answer = userAnswers[`q${i}`];
                    const question = quizData.questions[i];
                    if (answer === question.correctIndex) {
                        circle.classList.add('correct');
                        circle.querySelector('.circle-progress').setAttribute('stroke-dasharray', '188.5 188.5');
                    } else if (answer === question.partialIndex) {
                        circle.classList.add('wrong');
                        circle.querySelector('.circle-progress').setAttribute('stroke-dasharray', '94.25 188.5');
                    } else if (answer === -1) {
                        circle.classList.add('timeout');
                    } else {
                        circle.classList.add('wrong');
                    }
                }
                
                container.appendChild(circle);
            }
        }
        
        function kinyanStartTimer() {
            timeRemaining = 60;
            document.getElementById('timer-display').textContent = timeRemaining;
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                document.getElementById('timer-display').textContent = timeRemaining;
                
                const circle = document.getElementById('timer-circle');
                const circumference = 339.292;
                const offset = circumference * (1 - timeRemaining / 60);
                circle.setAttribute('stroke-dashoffset', offset);
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    kinyanHandleTimeout();
                }
            }, 1000);
        }
        
        function kinyanHandleTimeout() {
            userAnswers[`q${currentQuestionIndex}`] = -1;
            setTimeout(() => {
                currentQuestionIndex++;
                kinyanShowQuestion();
            }, 500);
        }
        
        window.kinyanSelectAnswer = function(answerIndex) {
            if (timerInterval) clearInterval(timerInterval);
            
            userAnswers[`q${currentQuestionIndex}`] = answerIndex;
            
            // Visual feedback
            const answers = document.querySelectorAll('.kinyan-answer');
            answers[answerIndex].classList.add('selected');
            
            setTimeout(() => {
                currentQuestionIndex++;
                kinyanShowQuestion();
            }, 500);
        };
        
        window.kinyanNextQuestion = function() {
            if (userAnswers[`q${currentQuestionIndex}`] === undefined) {
                userAnswers[`q${currentQuestionIndex}`] = -1;
            }
            currentQuestionIndex++;
            kinyanShowQuestion();
        };
        
        window.kinyanShowNeedReview = function() {
            alert('×ª×›×•× ×ª "×©× ×™×”, ×× ×™ ×¨×•×¦×” ×œ×‘×“×•×§ ×¨×’×¢" ×ª×”×™×” ×–××™× ×” ×‘×§×¨×•×‘!');
        };
        
        function kinyanShowResults() {
            if (timerInterval) clearInterval(timerInterval);
            
            const score = kinyanCalculateScore();
            
            const resultsHeader = document.getElementById('results-header');
            const socialStats = document.getElementById('social-stats');
            
            if (score >= 80) {
                resultsHeader.innerHTML = `
                    <h2 style="font-size: clamp(2rem, 3vw, 3rem); font-weight: bold; color: var(--gold);">
                        ××¢×•×œ×”! ×¤×¡×§×ª ×›××• ××•×¨×” ×”×•×¨××”! ğŸ†
                    </h2>
                `;
                socialStats.innerHTML = `
                    <p style="font-size: clamp(1.5rem, 2vw, 2rem); color: var(--dark-slate); margin: 1rem 0;">
                        <strong>×”×¦×™×•×Ÿ ×©×œ×š: ${score}%</strong>
                    </p>
                    <p style="font-size: clamp(1.2rem, 1.5vw, 1.5rem); color: var(--dark-slate);">
                        ×”×¦×œ×—×ª ×œ×”×›×¨×™×¢ × ×›×•×Ÿ ×‘×¨×•×‘ ×”×©××œ×•×ª ×”××¢×©×™×•×ª!
                    </p>
                `;
            } else {
                resultsHeader.innerHTML = `
                    <h2 style="font-size: clamp(2rem, 3vw, 3rem); font-weight: bold; color: var(--gold);">
                        ×™×© ××” ×œ×©×¤×¨
                    </h2>
                `;
                socialStats.innerHTML = `
                    <p style="font-size: clamp(1.5rem, 2vw, 2rem); color: var(--dark-slate); margin: 1rem 0;">
                        <strong>×”×¦×™×•×Ÿ ×©×œ×š: ${score}%</strong>
                    </p>
                    <p style="font-size: clamp(1.2rem, 1.5vw, 1.5rem); color: var(--dark-slate);">
                        ×”××¢×‘×¨ ××œ×™××•×“ ×ª×™××•×¨×˜×™ ×œ×¤×¡×™×§×” ××¢×©×™×ª ×”×•× ××ª×’×¨ ×’×“×•×œ.
                    </p>
                `;
            }
            
            kinyanShowScreen('screen-results');
        }
        
        function kinyanCalculateScore() {
            let totalPoints = 0;
            const totalQuestions = quizData.questions.length;
            
            for (let i = 0; i < totalQuestions; i++) {
                const userAnswer = userAnswers[`q${i}`];
                const question = quizData.questions[i];
                
                if (userAnswer === question.correctIndex) {
                    totalPoints += 1.0;
                } else if (question.partialIndex >= 0 && userAnswer === question.partialIndex) {
                    totalPoints += 0.5;
                }
            }
            
            return Math.round((totalPoints / totalQuestions) * 100);
        }
        
        console.log('âœ… Kinyan Horaah Widget initialized successfully');
        
    })();
    </script>
</body>
</html>
